\documentclass[sigplan,10pt,anonymous,review]{acmart}%
%\settopmatter{printfolios=true,printccs=false,printacmref=false}
% ??? Commented out?

% \usepackage[english]{babel}
\input{macros.tex}
%%
%% \BibTeX command to typeset BibTeX logo in the docs
\AtBeginDocument{%
  \providecommand\BibTeX{{%
    \normalfont B\kern-0.5em{\scshape i\kern-0.25em b}\kern-0.8em\TeX}}}

%% Rights management information.  This information is sent to you
%% when you complete the rights form.  These commands have SAMPLE
%% values in them; it is your responsibility as an author to replace
%% the commands and values with those provided to you when you
%% complete the rights form.
\setcopyright{acmcopyright}
\copyrightyear{2018}
\acmYear{2018}
\acmDOI{10.1145/1122445.1122456}

%% These commands are for a PROCEEDINGS abstract or paper.
\acmConference[Woodstock '18]{Woodstock '18: ACM Symposium on Neural
  Gaze Detection}{June 03--05, 2018}{Woodstock, NY}
\acmBooktitle{Woodstock '18: ACM Symposium on Neural Gaze Detection,
  June 03--05, 2018, Woodstock, NY}
\acmPrice{15.00}
\acmISBN{978-1-4503-XXXX-X/18/06}


%%
%% Submission ID.
%% Use this when submitting an article to a sponsored event. You'll
%% receive a unique submission ID from the organizers
%% of the event, and this ID should be used as the parameter to this command.
%%\acmSubmissionID{123-A56-BU3}

%%
%% The majority of ACM publications use numbered citations and
%% references.  The command \citestyle{authoryear} switches to the
%% "author year" style.
%%
%% If you are preparing content for an event
%% sponsored by ACM SIGGRAPH, you must use the "author year" style of
%% citations and references.
%% Uncommenting
%% the next command will enable that style.
%%\citestyle{acmauthoryear}

%%
%% end of the preamble, start of the body of the document source.
\begin{document}

%%
%% The "title" command has an optional parameter,
%% allowing the author to define a "short title" to be used in page headers.
\title{Universal Sets in Coq}

%%
%% The "author" command and its associated commands are used to define
%% the authors and their affiliations.
%% Of note is the shared affiliation of the first two authors, and the
%% "authornote" and "authornotemark" commands
%% used to denote shared contribution to the research.
\author{Andrea Condoluci}
\email{andreacondoluci@gmail.com}
\orcid{1234-5678-9012}
\affiliation{%
  \institution{Institute for Clarity in Documentation}
  \streetaddress{P.O. Box 1212}
  \city{Dublin}
  \state{Ohio}
  \postcode{43017-6221}
}

%%
%% By default, the full list of authors will be used in the page
%% headers. Often, this list is too long, and will overlap
%% other information printed in the page headers. This command allows
%% the author to define a more concise list
%% of authors' names for this purpose.
% \renewcommand{\shortauthors}{Trovato and Tobin, et al.}

%%
%% The abstract is a short summary of the work to be presented in the
%% article.
\begin{abstract}
New Foundations (\NF) is a somewhat bizarre alternative to mainstream set theories like Zermeloâ€“Fraenkel (\ZF). The distinguishing feature of \NF{} is permitting the construction of a \emph{universal set}, \ie{} a set that contains all sets (itself, too). Though counterintuitive, \NF{} is capable of expressing ordinary mathematical concepts like well-orders, ordinals, cardinals, natural numbers, and so on. Its adoption, however, is hampered by the fact that after more than 80 years since its introduction, the community has not yet agreed upon its logical consistency.
  
In this paper, we consider two weak sub-theories of \NF{} whose consistency has already been established: \NFTWO{} and \NFO. These theories are obtained from \NF{} by restricting the axiom schema of comprehension to quantifier-free formulas only. We provide an encoding of \NFTWO{} and \NFO{} in the Coq proof assistant, adapting in a non-trivial way the classic encoding of \ZF{} in Coq by Benjamin Werner. To our knowledge, this is the first mechanized consistency proof concerning New Foundations.
\end{abstract}

% %%
% %% The code below is generated by the tool at http://dl.acm.org/ccs.cfm.
% %% Please copy and paste the code instead of the example below.
% %%
% \begin{CCSXML}
% <ccs2012>
%  <concept>
%   <concept_id>10010520.10010553.10010562</concept_id>
%   <concept_desc>Computer systems organization~Embedded systems</concept_desc>
%   <concept_significance>500</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>10010520.10010575.10010755</concept_id>
%   <concept_desc>Computer systems organization~Redundancy</concept_desc>
%   <concept_significance>300</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>10010520.10010553.10010554</concept_id>
%   <concept_desc>Computer systems organization~Robotics</concept_desc>
%   <concept_significance>100</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>10003033.10003083.10003095</concept_id>
%   <concept_desc>Networks~Network reliability</concept_desc>
%   <concept_significance>100</concept_significance>
%  </concept>
% </ccs2012>
% \end{CCSXML}

% \ccsdesc[500]{Computer systems organization~Embedded systems}
% \ccsdesc[300]{Computer systems organization~Redundancy}
% \ccsdesc{Computer systems organization~Robotics}
% \ccsdesc[100]{Networks~Network reliability}

%%
%% Keywords. The author(s) should pick words that accurately describe
%% the work being presented. Separate the keywords with commas.
\keywords{set theory, New Foundations, universal set}

%%
%% This command processes the author and affiliation and title
%% information and builds the first part of the formatted document.
\maketitle

\section{Introduction}

The history of the foundations of mathematics has been a bumpy ride. In the early 20th century, contradictions like \emph{Russel's paradox} prompted an extensive search for new, solid foundations upon which to construct mathematics. \emph{Zermelo-Fraenkel} set theory (\ZF{}) has undeniably become the ``gold standard'' for mathematics, the point of reference against which to compare all mathematical theories and alternative foundations. However, various minor-league set theories exist, among which the lesser known \emph{New Foundations} (\NF) by Quine \cite{quine1937new}. As a logical theory, \NF{} is quite simple and elegant; however, \NF{} did not take off as a foundation for mathematics, mostly because the \NF{} community is not yet convinced of its consistency relative to \ZF{}.

\medskip

First of all, let us define formally what a set theory is. Later, in \Cref{subs:qfc}, we will introduce \NFTWO{} and \NFO{}, the fragments of \NF{} set theory whose formalization is the topic of this paper.

\subsection{Set theories.}\label{subs:st}
A \emph{set theory} is a first-order theory having the usual logical connectives ($\top$, $\neg$, $\land$, $\lor$, $\to$, $\leftrightarrow$, $\exists$, $\forall$) plus two relation symbols: \emph{equality} ($=$) and \emph{membership} ($\in$). Variables (like $x,y,z,\ldots$) range over sets, and a set is meant to represent a collection of sets: $x \in y$ means that $x$ is a \emph{member} or an \emph{element} of $y$.

%Formulas of set theory are thus described by the following grammar: 

% \[\begin{array}{rrl}
%   \varphi & \grameq & \bot \mid \neg \varphi \mid \varphi \land \varphi \mid \varphi \lor \varphi \\
%   & & \mid \forall x.\, \varphi \mid \exists x.\, \varphi \\
%   & & \mid x = y \mid x \in y .
% % \TODO{Oh no, we need $\leftrightarrow$!!!}
% \end{array}\]

Sets do not posses any internal structure other than their \emph{extension}, \ie{} the elements they contain. The \emph{axiom of extensionality} formalizes this fact by requiring that sets having the same extension are in fact the same set:
% 
\[\forall x y.\, x = y \leftrightarrow \forall z. \, z \in x \leftrightarrow z \in y \quad \tag{\SetExt} \]

A natural way to form a collection of sets is by gathering every set $x$ satisfying a given logic formula $\varphi$ (procedure called \emph{comprehension}); we express this collection in symbols by $\Compr x \varphi$, reading ``the collection of all $x$'s such that $\varphi$ holds''. A very natural property would be that collections specified by comprehension are sets themselves, as the \emph{axiom schema of comprehension} requires:
% 
\[ \exists y.\, \forall x.\, x \in y \leftrightarrow \varphi  \quad \tag{\SetCompr} \]

(where $y$ does not occur in $\varphi$; $\varphi$ may however have any number of free variables, and we implicitly assume axiom schemata to be universally closed.)

% We can just denote with $\Compr x \varphi$ the set that witnesses the existential ``$\exists y$'', which is unique by extensionality.
Set comprehension is actually an axiom \emph{schema}: the schema describes an axiom for every formula $\varphi$. Can all formulas be allowed? Unfortunately not: the infamous \emph{Russel's paradox} relies exactly on \emph{unrestricted} comprehension, and it is straightforward to obtain a contradiction by taking comprehension of a formula as simple as $\varphi \defeq x \not\in x$.\footnotemark{}

\footnotetext{By $x\not\in x$ we mean $\neg {(x \in x)}$. }

There are several ways to restrict \SetCompr{} so to avoid Russel's paradox. To a certain extent, Russel's contradiction is caused by malicious circularity in the formation of sets: the characterizing formula $\varphi$ spans across all sets, including the set that is being formed. \ZF's way to avoid circularity is to only allow comprehension of guarded formulas, of the form $x \in y \land \varphi$ for some $y\neq x$ and arbitrary $\varphi$. The resulting set is usually denoted by $\Compr {x \in y} \varphi$, and this flavor of \SetCompr{} is known as \emph{axiom schema of separation}. In this way, self-reference is not allowed because it is only possible to ``separate'' subsets of sets that already exist; moreover, additional axioms of \ZF{} force sets to have a \emph{well-founded} structure (most notably, the \emph{axiom of regularity}).

\paragraph{New Foundations.} After all, circularity is not necessarily evil. \NF's way to avoid inconsistencies is not to forbid circularity in the structure of sets, but to forbid circularity in the \emph{description} of sets: only \emph{stratified} instances of \SetCompr{} are allowed. A stratification of a formula is the assignment of a natural number to each \emph{bound} variable (we write $x^i$ to mean that the variable $x$ has been assigned the number $i$) in such a way that:
\begin{itemize}
  \item for every subformula $x^i = y^j$, it must hold $i=j$;
  \item for every subformula $x^i \in y^j$, it must hold $i+1=j$.
\end{itemize}
(We do not put too much stress on stratification, as we will not employ it directly in this paper, see the next subsection.)

Note that the schema of stratified comprehension does not force the collection $\Compr x {x \not\in x}$ to be a set, because the corresponding instance of comprehension cannot be stratified:
% 
\[ \exists y^{i+1}.\, \forall x^i.\, x^i \in y^{i+1} \leftrightarrow x^{\stkout{\textcolor{red}i}} \not\in x^{\stkout{\textcolor{red}i}}. \]

As a consequence, Russel's paradox is avoided; however, various bizarre sets are allowed to exist. For instance the \emph{universe}, the collection $\Compr x \top$ of all sets, is itself a set, because the corresponding instance of comprehension is stratified:
% 
\[ \exists y^{i+1}.\, \forall x^i.\, x^i \in y^{i+1} \leftrightarrow \top. \]

Even more counterintuitively, one can for instance define the set of all ordinals, or the set of all cardinals, which is inconceivable in \ZF{} (these sets can only be understood as \emph{proper classes} in \ZF{} set theory).

\medskip

The downside of \NF{} is the status of its consistency: even thought various candidate proofs of consistency of \NF{} relative to \ZF{} have been proposed in the last years by Randall Holmes, the logic community has not yet been able to validate them beyond doubt.

\subsection{Quantifier-free Comprehension}\label{subs:qfc}

In this paper we consider weaker fragments of full-fledged \NF{}, obtained by restricting the axiom of stratified comprehension to only formulas $\varphi$ that are quantifier-free. As we will see, this restriction produces sub-theories that have already been investigated in the literature, and whose models are quite straightforward.

In the case of quantifier-free stratified comprehension, we can actually drop the axiom schema of comprehension in favour of an equivalent axiomatization that employs only a few set operators ($\Universe, \Complement \Placeholder, \Union \Placeholder \Placeholder, \Sing\Placeholder, \Essence\Placeholder$) and the corresponding characterizing axioms. We will describe these set operators in the rest of this subsection, but first of all let us sketch how to derive this simpler axiomatization.

\medskip

Recall that by the definition of stratification, only bound variables are assigned indices. Thus, in an instance of the comprehension schema like $\exists y.\, \forall x.\, x \in y \leftrightarrow \varphi$, when $\varphi$ is quantifier-free, only $x$ and $y$ are to be assigned an index. Note that subformulas of $\varphi$ of the form $z = w$ or $z \in w$ which mention at least one free variable are trivially stratified. Moreover, since $y$ cannot occur in $\varphi$ by hypothesis, the only atomic formulas that do not mention any free variable are either $x=x$ (clearly stratified) or $x\in x$ (not stratifiable).
% 
Summarizing, quantifier-free stratification is equivalent to requiring that $x\in x$ does not occur as a subformula of $\varphi$.

\medskip

To understand what operations on sets are necessary to replace stratified comprehension, let us examine $\Compr x \varphi$ when $\varphi$ is stratified and quantifier-free, proceeding by cases on the structure of $\varphi$:

\[\begin{array}{lcll}
  \Compr x {x = x} & = & \Universe \\
  \Compr x {x = y} & = & \Sing y \\
  \Compr x {y = x} & = & \Sing y \\
  \Compr x {y = z} & = &
    \begin{cases}
      \Universe & \text{if } y = z\\
      \Complement \Universe & \text{otherwise}
    \end{cases}\\
  \Compr x {x \in y} & = & y \\
  \Compr x {y \in x} & = & \Essence y \\
  \Compr x {y \in z} & = &
    \begin{cases}
      \Universe & \text{if } y \in z\\
      \Complement \Universe & \text{otherwise}
    \end{cases}\\
  \Compr x {\neg\varphi} & = & \Complement {\Compr x \varphi} \\
  \Compr x {\varphi \lor \varphi'} & = & \Union {\Compr x \varphi} {\Compr x {\varphi'}} \\
\end{array}\]
(where $x\neq y$ and $x \neq z$.)

\medskip

\noindent The required operators are thus the following:
\begin{enumerate} \renewcommand\labelitemi{--}
  \item The universal set, denoted by $\Universe$:
    \begin{flalign*} \hspace{50pt} %
      \forall z.\, z \in \Universe \sctag{Universe} %
      && \end{flalign*}
  \item Set complement, denoted by $\Complement \Placeholder$:
  \begin{flalign*} \hspace{50pt} %
      \forall z.\, z \in \Complement x \leftrightarrow \neg (z \in x) \sctag{Complement}
      && \end{flalign*}
  \item Set union, denoted by $\Union \Placeholder \Placeholder$:
  \begin{flalign*} \hspace{50pt} %
      \forall z.\, z \in \Union x y \leftrightarrow z \in x \lor z \in y \sctag{Union}
      && \end{flalign*}
  \item Singleton, denoted by $\Sing\Placeholder$:
  \begin{flalign*} \hspace{50pt} %
      \forall z.\, z \in \Sing x \leftrightarrow x = z \sctag{Singleton} 
      && \end{flalign*}
  \item The \emph{essence} of a set, denoted by $\Essence\Placeholder$:
  \begin{flalign*} \hspace{50pt} %
      \forall z.\, z \in \Essence{x} \leftrightarrow x \in z \sctag{Essence} 
      && \end{flalign*}
\end{enumerate}

\medskip

Let us further explain these operators:
\begin{itemize}
  \item 
  Singleton, union, and complement are familiar operations on sets that do not need further clarification. The universal set is unconventional, but quite intuitive. These operators (1---4), together with \SetExt, characterize the theory known as \NFTWO{}, whose model we will formalize in \Cref{sect:nf2}.
  
  \item The last operator, the essence of a set, is the most peculiar (and also the most difficult to accommodate in a model). \Essence{x} denotes the set of all sets containing $x$, a set that is not possible to form in usual \ZF. The term ``essence'' was introduced by Whitehead, but we denote it with the letter $\Verb{B}$ following Forster, that used $\Verb{B}$ as homage to Maurice Boffa.\cite{Forster2001}
  
  All set operators introduced above (1---5), together with \SetExt, characterize the theory known as \NFO{}, whose model we will formalize in \Cref{sect:nfo}.
\end{itemize}

\subsection{Sets in Coq}
The goal of this paper is to encode models for \NFTWO{} and \NFO{} in the Coq proof assistant \cite{coq} (let us temporarily abbreviate \NFTWO/\NFO{} with \NFX{}).
% 
The basic idea is performing a \emph{shallow embedding} of \NFX{} in \Coq, where:

\begin{itemize}
  \item 
    The logic formulas of \NFX{} are interpreted to \Coq{} expressions so that logical connectives of \NFX{} are mapped to the corresponding ones in \Coq{}. In this way, the usual axiom of first-order logic hold automatically. One slight inconvenience is that \NFX{} are theories based on \emph{classical logic}, while \Coq's logic is constructive. To formalize \NFX{} we need to assume excluded middle as an axiom; however, we kept usage of classical reasoning to the minimum, so to be able to later generalize our formalization to constructive variants of \NFX{} (see \Cref{sub:future} about future work).
  \item The collection of \NFX{} sets is encoded as a \Coq{} type; the predicates of \NFX{} (equality and membership) plus the various set operators are encoded as \Coq{} terms. Importantly, from now on we will denote the equality relation on \NFX{} sets by $\equiv$ instead of $=$, so to distinguish it from \Coq{} \emph{intensional} equality $=$.
\end{itemize}

Our starting point the is the classic formalization of \ZF{} (more precisely, a constructive variant of \ZF{} called \ZFC{}) in costructive type theory by Peter Aczel \cite{ACZEL197855}, later implemented in Coq by Benjamin Werner \cite{DBLP:conf/tacs/Werner97}. We will provide an overview of Werner's formalization in \Cref{sect:zf}, so to make the adaptation to \NFX{} easier to grasp.

\section{Roadmap}
The rest of the paper is structured as follows:
\Cref{sect:zf} describes the encoding of \ZF{} in \Coq{}, so to lay the ground for next sections and define concepts that will be reused throughout; \Cref{sect:nf2} and \Cref{sect:nfo} describe the encoding of \NFTWO{} and \NFO{} respectively; \Cref{sect:discussion} contains the conclusions and future directions for research.

\noindent
\paragraph{Contributions.}
Our formalization consists of around 2.5K lines of \Coq{} code. The main source for the models used here is \cite{Forster2001}; that paper provides the informal construction of \NFX{} sets, but proofs that these constructions are really models are either sketched or absent.

Adapting the encoding of \ZF{} to an encoding of \NFTWO{} is relatively straightforward, the only challenge being the proof of extensionality, which requires different intuitions.

Encoding \NFO{} has proven much harder: the recursive definitions of set equality and membership each employ a different termination order, and a further one is necessary just to prove that set equality is an equivalence relation (which is a straightforward proof in \ZF); moreover, extensionality of \NFO{} is strictly harder the one of \NFTWO{}, requiring a similar but more involved argument.

Note that \NFTWO{} is really a sub-theory of \NFO, hence the model provided for \NFO{} is also a model for \NFTWO. We decided to provide separate models for the two theories, so to better illustrate how Aczel's encoding can be adapted to accommodate further set constructors. We believe this step-by-step approach helps illustrating the distinct challenges of the two theories, which is also a contribution of this paper.

Lastly, the various required termination orders mentioned above prompted us to develop a \Coq{} library proving the well-foundedness of the \emph{multiset ordering}, independent from \NFX. Contrary to existing libraries, our library does not require equality on the elements of multisets to be decidable.


\section{\ZF}
\label{sect:zf}
\input{ZF.tex}

\section{\NFTWO}
\label{sect:nf2}
\input{NF2.tex}

\section{\NFO}
\label{sect:nfo}
\input{NFO.tex}

\section{Discussion}\label{sect:discussion}
We have encoded in the \Coq{} proof assistant models for \NFTWO{} and \NFO{}, two weak sub-teories of \NF{}. These theories are known in the \NF{} community, and the sketch of these models can be found for example in \cite{Forster2001}. Formalizing the models in type theory has proven quite challenging: it was both necessary to extend the original Aczel's encoding in non-trivial way, and to prove by scratch that so-obtained models actually satisfy extensionality.

\subsection{Related Work}
As already mentioned multiple times, our primary source is \cite{Forster2001} by Forster. We are not aware of any existing encoding of sub-theories of \NF{} in any proof assistant.
It is however worth to mention the axiomatization of \NF{} in $\Verb{metamath}$ by Scott Fenton from 2015\footnotemark; that formalization however takes an axiomatic approach, hence it is not suitable to extablish any relative consistency of \NF{}.
\footnotetext{See \url{http://us.metamath.org/nfeuni/mmnf.html}.}

Another piece of work worth mentioning is the \emph{Watson} theorem prover by Randall Holmes\footnotemark, which however uses \NF{} as meta-theory, and thus cannot extablish relative consistency as well.
\footnotetext{See \url{https://randall-holmes.github.io/Watson/proverpage.html}.}


\subsection{Future Work}
\label{sub:future}
We now sketch some possible directions for future work:
\begin{itemize}
  \item A direction that we intend to explore is to remove all classical reasoning from the our encoding by only restricting ourselves to index sets that are both decidable and finite (the only required property for index sets is to be closed under union and subset). In this restricted setting, equality and membership would not only become decidable predicates, but we would obtain effective procedures to compute them.
  \item Another direction to explore is constructive versions of \NFX, that are already studied in the literature (see for instance \cite{XXX}).
  \item A topic more applied to computer science is to understand the relationship between \NFO{} sets and type systems for extensible records. It seems possible to adapt a model of \NFO{} to a model for a record types system featuring union types and complementation. For example, one could model an extensible record like $\{l_1\colon t_1, \ldots, l_n\colon t_n, \_\}$ where $l_1,\ldots,l_k$ are lables and $t_i$ are types, by the \NFO{} set $\Essence{(l_1\colon t_1)}\cap\cdots\cap \Essence{(l_n\colon t_n)}$. Of course, it would be necessary to extend the language of sets to accommodate labels.
\end{itemize}



%%
%% The acknowledgments section is defined using the "acks" environment
%% (and NOT an unnumbered section). This ensures the proper
%% identification of the section in the article metadata, and the
%% consistent spelling of the heading.
% \begin{acks}
% To Robert, for the bagels and explaining CMYK and color spaces.
% \end{acks}

%%
%% The next two lines define the bibliography style to be used, and
%% the bibliography file.
\bibliographystyle{ACM-Reference-Format}
\bibliography{main}

%%
%% If your work has an appendix, this is the place to put it.
\appendix


\end{document}
\endinput
